!function(){angular.module("Controllers",["FoodOrDrinks","Sections","Food","OrderRecap","NewOrder"])}(),function(){var t=angular.module("Food",["Services"]);t.controller("FoodCtrl",["$scope","menu",function(t,e){t.modal={visible:!1,data:{food:{}}},e.getFoodList(t.appstate.menuType,t.appstate.section).then(function(e){t.foodList=e}),e.getQuickNotes(t.appstate.section).then(function(e){t.quickNotes=e.map(function(t){return{selected:!1,text:t}})}),t.orderFood=function(e){t.appstate.order.addFood({menuType:t.appstate.menuType,food:e,quantity:1})},t.reduceFood=function(e){var n=t.appstate.order.getItem({food:e});t.appstate.order.reduceQuantity(n)},t.showModal=function(e){t.modal.visible=!0,t.modal.data.food=e},t.hideModal=function(){var e,n;n=t.quickNotes.filter(function(t){return t.selected}).map(function(t){return t.text}).join(", "),e=t.appstate.order.getItem({food:t.modal.data.food}),t.appstate.order.addNote(e,n),t.modal.visible=!1}}])}(),function(){var t=angular.module("FoodOrDrinks",[]);t.controller("FoodOrDrinksCtrl",["$scope",function(t){t.selectMenu=function(e){t.appstate.menuType=e,t.appstate.setView("sections")}}])}(),function(){var t=angular.module("NewOrder",["Services"]);t.controller("NewOrderCtrl",["$scope","restaurant","waiter",function(t,e,n){function o(e){console.log("Confirming order",e),t.appstate.room=e.room,t.appstate.order=n.createOrder(e.tables),t.appstate.setView("food-or-drinks")}function r(n){e.getTables(n).then(function(e){t.tables=e})}var a={room:{},tables:[],selectTable:function(t){-1==a.tables.indexOf(t)?a.tables.push(t):a.tables.splice(a.tables.indexOf(t),1)},isSelected:function(t){return-1!=a.tables.indexOf(t)}};t.neworder=a,t.confirmTables=o,t.$watch("neworder.room",r),e.getRooms().then(function(e){t.rooms=e,t.neworder.room=t.rooms[0],r(t.neworder.room)})}])}(),function(){var t=angular.module("OrderRecap",["Services"]);t.controller("OrderCtrl",["$scope","waiter",function(t,e){t.orderContent=t.appstate.order.getContent(),t.total=t.appstate.order.getTotal(),t.removeFood=function(e){console.log(e,"removing!"),t.appstate.order.removeItem(e)},t.orderFood=function(e){t.appstate.order.addFood({food:e.food,menuType:e.menuType,quantity:1,note:e.note})},t.reduceFood=function(e){t.appstate.order.reduceQuantity(e)},t.showNote=function(e){t.note={visible:!0,item:e,text:e.note},console.log("Please add note :D",e.food.name,e.quantity)},t.sendToKitchen=function(t){e.sendOrder(t)},t.sendInvoice=function(t){e.sendInvoice(t)},t.multiply=function(t,e){return parseFloat(t)*parseFloat(e)},t.saveNote=function(e){console.log(e),t.appstate.order.addNote(e.item,e.text),console.log(t.appstate.order.getContent())}}])}(),function(){function t(t){return function(e){return e[t]}}var e=angular.module("RMT",["Services","Controllers","Directives","templates","ngTouch","ngStorage"]);e.run(["$rootScope","$sessionStorage","restaurant","waiter",function(e,n,o,r){e.$on("$locationChangeStart",function(e){var a;n.$default({orders:[]}),a=n.orders.reduce(function(e,n){return e.concat(n.tablesArray.map(t("id")))},[]),r.loadExistingOrders(n.orders),o.setBusyTables(a),e.preventDefault()})}]),e.controller("RMTCtrl",["$scope","restaurant","waiter","menu","$sessionStorage",function(t,e,n,o,r){t.appstate=function(){var t=[];return{currentView:"table-selection",canGoBack:!1,setView:function(e){this.currentView!==e&&(t.push(this.currentView),this.currentView=e,this.canGoBack=!0)},goBack:function(){t.length&&(this.currentView=t.pop(),0===t.length&&(this.canGoBack=!1))}}}()}]),e.controller("TablesCtrl",["$scope","restaurant","waiter",function(e,n,o){function r(t){n.getTables(t).then(function(t){e.tables=t})}n.getRooms().then(function(t){e.rooms=t,e.appstate.room=t[0],r(e.appstate.room)}),e.selectRoom=function(t){e.appstate.room=t,r(e.appstate.room)},e.selectTable=function(t){e.appstate.table=t,e.appstate.order=o.getOrder(t),e.appstate.setView("food-or-drinks")},e.activeOrdersCount=function(){return e.tables&&e.tables.length?e.tables.filter(t("busy")).length:void 0}}])}(),function(){var t=angular.module("Sections",["Services"]);t.controller("SectionsCtrl",["$scope","menu",function(t,e){e.getSections(t.appstate.menuType).then(function(e){t.sections=e}),t.selectSection=function(e){t.appstate.section=e,t.appstate.setView("food")}}])}(),function(){angular.module("Directives",["FoodEntry","RMTModal"])}(),function(){var t=angular.module("FoodEntry",[]);t.directive("foodEntry",function(){return{restrict:"E",transclude:!0,scope:{name:"=",quantity:"=",note:"=",onplus:"&",onminus:"&",onnote:"&?"},templateUrl:"directives/foodEntry.html",link:function(t,e,n){t.$watch("showQuantity",function(e){e&&!t.quantity&&t.onplus()}),t.clicked=function(){t.onnote?t.showMiddleStep=!0:t.showQuantity=!0}}}})}(),function(){var t=angular.module("RMTModal",[]);t.directive("rmtModal",function(){return{restrict:"E",transclude:!0,scope:{rmtModalTitle:"=",rmtModalOnclose:"&"},templateUrl:"directives/rmtModal.html",link:function(t,e,n){}}})}(),function(){var t=angular.module("Menu",[]);t.factory("menu",["$http",function(t){function e(t){var e={},n=new Promise(function(n,o){Papa.parse(t,{download:!0,complete:function(t){var o;$.each(t.data,function(t,n){var r,a=n.length;for(r=0;a>r;r++)n[r]&&n.push(n[r]);if(n.splice(0,a),0!==n.length)if(1==n.length)o=n[0],e[o]=[];else{if(!n[0].trim())return;var i={name:n[0],price:parseFloat(n[1].replace(/,/,"."))};e[o].push(i)}}),n(e)}})});return n}function n(e){return t.get(e).then(function(t){return t.data.quickNotes})}function o(t){return{foodMenu:t[0],drinksMenu:t[1]}}var r,a="/assets/menu/menu_cibo.csv",i="/assets/menu/menu_bere.csv",u="/assets/menu/note.json",s=e(a),c=e(i),d=n(u);return r=Promise.all([s,c]).then(o),{getSections:function(t){return r.then(function(e){return Object.getOwnPropertyNames(e[t])})},getFoodList:function(t,e){return r.then(function(n){return n[t][e]})},getQuickNotes:function(t){return d.then(function(e){var n,o=t.toUpperCase();return n=e.find(function(t){return t.section.toUpperCase()==o}),n?n.notes:[]})}}}])}(),function(){var t=angular.module("Order",[]);t.factory("orderGenerator",function(){var t=function(t){return{date:(new Date).toISOString(),room:t[0].roomid,tablesArray:t,content:[],getContent:function(){return this.content},getTotal:function(){return this.content.reduce(function(t,e){return t+=e.quantity*e.food.price},0)},getCount:function(){return this.content.length},addFood:function(t){var e=this.getItem(t);e?e.quantity+=t.quantity:this.content.push({food:t.food,menuType:t.menuType,quantity:t.quantity,note:t.note||void 0})},addNote:function(t,e){t.note&&t.note!=e?t.note=e:t.note||(this.reduceQuantity(t),0===t.quantity&&this.removeItem(t),this.addFood({food:t.food,menuType:t.menuType,quantity:1,note:e}))},reduceQuantity:function(t){0!==t.quantity&&(t.quantity-=1)},getItem:function(t){var e=this.content.find(function(e){var n=e.food.name==t.food.name,o=e.note==t.note;return t.note||e.note?n&&o:n});return e},removeItem:function(t){this.content.splice(this.content.indexOf(t),1)},setSent:function(t){t.sent=!0},toBeSent:function(t){return!t.sent},getQuantity:function(t){var e=this.getItem({food:t});return e?e.quantity:0}}};return{createOrder:function(e){return new t(e)}}})}(),function(){var t=angular.module("Restaurant",["ngStorage"]);t.factory("restaurant",["$http","$sessionStorage","waiter",function(t,e,n){function o(t){t.forEach(function(t,e){for(var o={name:t.name,id:e,tables:[]},a=0;a<t.tables;a++){var i=t.prefix+a;o.tables.push({id:i,roomid:t.name,busy:n.isTableIDBusy(i)})}r.push(o)})}var r=[],a=t.get("/assets/restaurant/rooms.json").then(function(t){o(t.data)});return{getRooms:function(){return a.then(function(){return r})},getTables:function(t){return a.then(function(){var e=r.indexOf(t);return-1!=e?r[e].tables:void 0})},setBusyTables:function(t){a.then(function(){r.forEach(function(e){e.tables=e.tables.map(function(e){return e.busy=-1!==t.indexOf(e.id)?!0:!1,e})})})}}}])}(),function(){var t=angular.module("RmtAPI",[]);t.factory("rmtAPI",["$http",function(t){function e(){console.log("Success!")}function n(){console.log("Fail!"),Promise.reject()}return{sendOrder:function(o){return t.post("/printOrder",o).then(e,n)},sendInvoice:function(o){return t.post("/printInvoice",o).then(e,n)}}}])}(),function(){angular.module("Services",["Waiter","Restaurant","Menu","RmtAPI"])}(),function(){var t=angular.module("Waiter",["Order","RmtAPI","ngStorage"]);t.factory("waiter",["orderGenerator","rmtAPI","$sessionStorage",function(t,e,n){function o(t){return function(e){return e[t]}}function r(t){var e=n.orders.indexOf(t);n.orders.splice(e,1)}n.orders;return{createOrder:function(e){var o=t.createOrder(e);return e.forEach(function(t){var e=this.getOrder(t);e&&(e.tablesArray.forEach(function(t){t.busy=!1}),r(e)),t.busy=!0}.bind(this)),n.orders.push(o),o},loadExistingOrders:function(t){t.forEach(function(t){var e;e=this.createOrder(t.tablesArray),e.content=t.content,e.date=t.date}.bind(this))},getOrder:function(t){var e=n.orders.find(function(e){return e.tablesArray.find(function(e){return t.id===e.id})});return e},isTableIDBusy:function(t){var e=n.orders.map(o("tablesArray")).map(function(t){return t.map(o("id"))}),r=e.find(function(e){return e.find(function(e){return e===t})});return r&&r.length?!0:!1},sendOrder:function(t){var n={room:t.room,table:t.tablesArray.map(function(t){return t.id}).join(" + "),order:t.getContent().filter(t.toBeSent)};console.log("Sending",n),e.sendOrder(n).then(function(){}),n.order.map(t.setSent)},sendInvoice:function(t){var n={room:t.room,table:t.tablesArray.map(function(t){return t.id}).join(" + "),date:t.date,order:t.getContent(),total:t.getTotal()};console.log("Sending invoice",n),e.sendInvoice(n).then(function(){})}}}])}();